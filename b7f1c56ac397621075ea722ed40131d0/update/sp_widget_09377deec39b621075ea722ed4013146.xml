<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function ($scope, $location, spUtil, $timeout) {
  var c = this;

  c.data.filteredRecognitions = [];
  c.isLoading = false;
  c.isLoadingMore = false;
  c.canLoadMore = true;
  c.showRefreshIndicator = false; // Flag to show the new recognition indicator

  c.offset = 0;
  c.limit = c.options.limit || 10;

  // Default filter state
  c.filters = getDefaultFilters();

  // This function now simply broadcasts a message and then re-fetches the data.
  c.resetFilters = function () {
    // Tell all listening child widgets to reset themselves
    $scope.$broadcast('filters.reset');

    c.showRefreshIndicator = false;

    // Reset the parent's data model
    c.filters = getDefaultFilters();

    // Fetch the new, unfiltered data
    c.setTab(c.activeTab);
  };

  // Check if any filter is active
  c.hasActiveFilters = function () {
    return c.filters.activity !== 'all' ||
      c.filters.timeframe !== 'all' ||
      c.filters.occasions.length > 0 ||
      c.filters.team.length > 0 ||
      c.filters.teamMember.length > 0;
  };


  c.setTab = function (tabName) {
    if (!tabName) return;

    c.data.filteredRecognitions = [];

    c.activeTab = tabName;
    $location.hash(tabName);

    c.offset = 0;
    c.canLoadMore = true;
    c.isLoading = true;
    c.showRefreshIndicator = false;

    loadFeed(tabName, 0, false);
  };

  c.loadMore = function () {
    if (!c.canLoadMore || c.isLoadingMore) return;


    c.isLoadingMore = true;

    loadFeed(c.activeTab, c.offset, true);
  };

  // Hide refresh banner and do a feed refresh
  c.refreshAndShow = function () {
    c.showRefreshIndicator = false;
    c.setTab(c.activeTab);
  };


  var initialTab = $location.hash() || 'you';
  c.setTab(initialTab);

  $scope.$on('$locationChangeSuccess', function () {
    var newTab = $location.hash();

    if (newTab && newTab !== c.activeTab) {
      c.setTab(newTab);
    }
  });

  // Event listeners for filters
  $scope.$on('activity.filter.updated', function (event, data) {
    c.showRefreshIndicator = false;

    if (c.filters.activity !== data.selected.value) {
      c.filters.activity = data.selected.value;
      c.setTab(c.activeTab);
    }
  });

  $scope.$on('teammember.filter.updated', function (event, data) {
    c.showRefreshIndicator = false;

    c.filters.teamMember = data.selected.map(item => item.value);
    c.setTab(c.activeTab);
  });

  $scope.$on('team.filter.updated', function (event, data) {
    c.showRefreshIndicator = false;

    c.filters.team = data.selected.map(item => item.value);
    c.setTab(c.activeTab);
  });

  $scope.$on('timeframe.filter.updated', function (event, data) {
    c.showRefreshIndicator = false;

    if (c.filters.timeframe !== data.selected.value) {
      c.filters.timeframe = data.selected.value;
      c.setTab(c.activeTab);
    }
  });

  $scope.$on('occasion.filter.updated', function (event, data) {
    c.showRefreshIndicator = false;

    // For multi-select, data.selected is an array of objects
    c.filters.occasions = data.selected.map(item => item.value);
    c.setTab(c.activeTab);
  });

  $scope.$on('sort.order.updated', function (event, data) {
    c.showRefreshIndicator = false;

    if (c.filters.sortOrder !== data.selected.value) {
      c.filters.sortOrder = data.selected.value;
      c.setTab(c.activeTab);
    }
  });


  let debounceTimer = null;
  function handleRecognitionInsert(response) {
    console.log('New recognition inserted: ', response);

    if (response.data.operation !== 'insert') return;

    $timeout.cancel(debounceTimer);

    debounceTimer = $timeout(function () {
      const isRelevantView = c.filters.sortOrder === 'newest';
      if (!isRelevantView || c.showRefreshIndicator) return;

      const currentTopId = c.data.filteredRecognitions.length > 0 ? c.data.filteredRecognitions[0].id : null;

      // Check if the new recognition is newer than the current top item
      c.server.get({
        action: 'get_latest_recognition_id',
        feedType: c.activeTab,
        filters: c.filters,
        currentTopId: currentTopId
      }).then(function (response) {
        console.log('Latest recognition check response: ', response);
        const payload = response.data.payload;

        if (!payload || !payload.newRecognition) return;

        // Show banner for new recognition sent by others
        if (!payload.isSelf) {
          c.showRefreshIndicator = true;
          return
        }

        const transformedItem = transformRecognitions([payload.newRecognition])[0];

        // Add a flag for the CSS highlight effect
        transformedItem.isNew = true;
        c.data.filteredRecognitions.unshift(transformedItem);
        c.offset++;

        // // Remove the highlight class after the animation completes
        // $timeout(function () {
        //   transformedItem.isNew = false;
        // }, 3500);

      });

    }, 750); // 750ms debounce

  }

  spUtil.recordWatch($scope, 'x_1794402_peerce_0_peer_recognition', '', handleRecognitionInsert);


  function getDefaultFilters() {
    return {
      activity: 'all',
      timeframe: 'all',
      occasions: [],
      sortOrder: 'newest',
      team: [],
      teamMember: []
    };
  }

  function loadFeed(feedType, offset, append) {
    // console.log('Filters: ', c.filters);

    c.server.get({ feedType, limit: c.limit, offset, filters: c.filters, action: 'getFeed' })
      .then(function (response) {
        const newRecognitions = transformRecognitions(response.data.recognitions || []);

        if (append) {
          c.data.filteredRecognitions = c.data.filteredRecognitions.concat(newRecognitions);
        } else {
          c.data.filteredRecognitions = newRecognitions;
        }

        // Update the offset
        c.offset = offset + newRecognitions.length;

        // If we got fewer than the limit, no more records left to load
        c.canLoadMore = newRecognitions.length >= c.limit;

      })
      .catch(function (error) {
        console.error('Failed to load feed:', error);
        if (!append) c.data.filteredRecognitions = [];

      }).finally(function () {
        c.isLoading = false;
        c.isLoadingMore = false;
      });
  }

  function transformRecognitions(recognitions) {
    return recognitions.map(function (rec) {
      return {
        ...rec,
        senderInitials: generateInitials(rec.senderDisplay),
        timeAgo: formatTimeAgo(rec.createdOn)
      };
    });
  }

  function generateInitials(name) {
    if (!name) return '?';

    return name.split(/\s+/)
      .map(part => part[0] ? part[0].toUpperCase() : '')
      .join('')
      .substring(0, 2) || '?';
  }


  function formatTimeAgo(dateTime) {
    if (!dateTime) return '';

    var m = moment(dateTime, "YYYY-MM-DD HH:mm:ss");

    return m.fromNow();
  }


  moment.updateLocale('en', {
    relativeTime: {
      future: "in %s",
      past: "%s ago",
      s: "a few seconds",
      ss: "%d seconds",
      m: "a minute",
      mm: "%d minutes",
      h: "an hour",
      hh: "%d hours",
      d: "a day",
      dd: "%d days",
      M: "a month",
      MM: "%d months",
      y: "a year",
      yy: "%d years"
    }
  });
};]]></client_script>
        <controller_as>c</controller_as>
        <css>.nav-tabs li a:hover {
    cursor: pointer;
}

.nav-tabs &gt; li &gt; a:focus,
.nav-tabs &gt; li &gt; a:active {
    outline: none;
    box-shadow: none;
}

.nav-tabs &gt; li.active &gt; a {
    border: none;
    border-bottom: 0.2rem solid #2d7524;
}

.refresh-btn {
    border-bottom: none;
}

.refresh-btn .fa-refresh {
    font-size: 18px !important;
    color: #666;
    transition: transform 0.1s ease;
}

.refresh-btn:active .fa-refresh {
    transform: scale(0.9);
}

.refresh-btn:focus,
.refresh-btn:active {
    outline: none;
    box-shadow: none !important;
    background-color: transparent !important;
    border-color: transparent !important;
}
/* ───────────────────────────────
  Control Bar
  ─────────────────────────────── */
.controls-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #fff;
    border-bottom: 1px solid #eee;
}

.filters {
    display: flex;
    gap: 12px; /* Increased gap for better spacing */
    align-items: center;
}

/* This is a new class for spacing our widgets */
.filter-wrapper {
    display: inline-block;
}

/* ───────────────────────────────
  Reset Link
  ─────────────────────────────── */
.reset-link {
    color: #999;
    text-decoration: none;
    margin-left: 6px;
    line-height: 1;
}

.reset-link:hover {
    color: #2d7524;
}

/* This container is the positioning anchor for the overlay */
.feed-container {
    position: relative;
}

/* This is the spinner overlay itself */
.feed-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
    display: flex;
    justify-content: center;

    align-items: flex-start;

    padding-top: 50px;

    background: white;
}

/* New recognition banner styles */
.refresh-indicator {
    background-color: #eef6f8;
    border: 1px solid #cce6ec;
    border-radius: 4px;
    color: #005f79;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    margin: 0;
}

.refresh-indicator.is-sticky {
    position: -webkit-sticky;
    position: sticky;
    top: 0;
    z-index: 1020;
    border-radius: 0;
    border-left: none;
    border-right: none;
    border-top: none;
}

.refresh-indicator-content {
    display: flex;
    align-items: center;
    flex-grow: 1;
}

.refresh-indicator-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.refresh-icon {
    margin-right: 8px;
    font-size: 16px;
    color: #0080a3;
}

.refresh-indicator .close {
    font-size: 20px;
    line-height: 1;
    opacity: 0.6;
    color: #005f79;
    text-shadow: none;
    padding: 0;
    margin-left: 10px;
}

.refresh-indicator .close:hover {
    opacity: 1;
    color: #000;
}

.refresh-indicator .btn-primary {
    background-color: #0080a3;
    border-color: #0080a3;
    color: #fff;
    font-weight: 600;
    padding: 4px 10px;
    font-size: 12px;
}

.refresh-indicator .btn-primary:hover {
    background-color: #006a88;
    border-color: #006a88;
}

/* This is the list of recognitions */
.feed-content {
    opacity: 1;
    transition: opacity 0.4s linear;
}

.feed-content li {
    list-style-type: none;
}

/* This class is applied to the list when the spinner is active */
.feed-content.content-faded {
    opacity: 0.5;
    pointer-events: none;
}

.new-badge {
    margin-right: 8px;
    vertical-align: middle;
}

.recognition-indicators abbr {
    display: inline-block;
    cursor: pointer;
}

.private-indicator {
    color: #7b6ea2;
}

.team-indicator {
    color: #007bff;
}

.occasion-tag {
    font-size: 1.2rem;
    border-radius: 3px;
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>recognition_feed</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Recognition Feed</name>
        <option_schema>[{"hint":"Number of records displayed in a page.","name":"limit","section":"Data","default_value":"15","label":"Record Limit","type":"integer"}]</option_schema>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function () {
  initializeFilters();

  if (input && input.action == 'getFeed') {
    let currentFeed = input.feedType || 'you';
    let limit = parseInt(input.limit, 10) || 15;
    let offset = parseInt(input.offset, 10) || 0;
    let filters = input.filters || {};

    let recognitionDAO = new x_1794402_peerce_0.RecognitionDAO();

    data.recognitions =
      recognitionDAO.getRecognitionsForFeed(
        currentFeed,
        limit,
        offset,
        filters
      ) || [];
  }

  if (input && input.action == 'get_latest_recognition_id') {
    data.payload = null;

    let currentFeed = input.feedType || 'you';
    let limit = 1;
    let offset = 0;
    let filters = input.filters || {};

    // Skip the check if not sorting by newest, as we don't need to show indicator or prepend it
    if (filters.sortOrder !== 'newest') return;

    let recognitionDAO = new x_1794402_peerce_0.RecognitionDAO();

    const latestRecognitions =
      recognitionDAO.getRecognitionsForFeed(currentFeed, limit, offset, filters) || [];

    // If no recognitions found, exit early
    if (latestRecognitions.length === 0) return;

    const latestRecognition = latestRecognitions[0];

    if (latestRecognition.id !== input.currentTopId) {
      data.payload = {
        newRecognition: latestRecognition,
        isSelf: latestRecognition.senderId === gs.getUserID()
      };
    }

    // data.latestRecognitionId = latestRecognition.length > 0 ? latestRecognition[0].id : null;
  }

  function initializeFilters() {
    data.activityFilterWidget = $sp.getWidget('single-select-filter', {
      title: 'Activity',
      eventName: 'activity.filter.updated',
      choices: [
        { display: 'All', value: 'all' },
        { display: 'Sent', value: 'sent' },
        { display: 'Received', value: 'received' },
      ],
      initialSelection: 'all',
    });

    data.timeframeFilterWidget = $sp.getWidget(
      'single-select-filter',
      {
        title: 'Timeframe',
        eventName: 'timeframe.filter.updated',
        choices: [
          { display: 'All Time', value: 'all' },
          { display: 'Last 7 days', value: '7' },
          { display: 'Last 30 days', value: '30' },
          { display: 'Last 90 days', value: '90' },
        ],
        initialSelection: 'all',
      }
    );

    data.teamMemberFilterWidget = $sp.getWidget(
      'multi-select-slushbucket-filter',
      {
        title: 'Team member',
        eventName: 'teammember.filter.updated',
        type: 'dynamic',
        dataConfig: {
          tableName: 'sys_user',
          displayField: 'name',
          valueField: 'sys_id',
          encodedQuery: 'active=true',
        },

        initialSelection: '',
      }
    );

    data.teamFilterWidget = $sp.getWidget(
      'multi-select-slushbucket-filter',
      {
        title: 'Team',
        eventName: 'team.filter.updated',
        type: 'dynamic',
        dataConfig: {
          tableName: 'sys_user_group',
          displayField: 'name',
          valueField: 'sys_id',
          encodedQuery: 'active=true',
        },

        initialSelection: '',
      }
    );


    var recognitionOccasions =
      new x_1794402_peerce_0.RecognitionUtils().getRecognitionOccasions();

    data.occasionFilterWidget = $sp.getWidget(
      'multi-select-slushbucket-filter',
      {
        title: 'Occasions',
        eventName: 'occasion.filter.updated',
        choices: recognitionOccasions,
        initialSelection: '',
      }
    );

    data.sortOrderWidget = $sp.getWidget('single-select-filter', {
      title: '',
      eventName: 'sort.order.updated',
      choices: [
        {
          display: '<i class="fa fa-sort-amount-desc"></i>',
          value: 'newest',
        },
        {
          display: '<i class="fa fa-sort-amount-asc"></i>',
          value: 'oldest',
        },
      ],
      initialSelection: 'newest',
    });
  }
})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-08-14 13:19:41</sys_created_on>
        <sys_id>09377deec39b621075ea722ed4013146</sys_id>
        <sys_mod_count>530</sys_mod_count>
        <sys_name>Recognition Feed</sys_name>
        <sys_package display_value="PeerCentral" source="x_1794402_peerce_0">b7f1c56ac397621075ea722ed40131d0</sys_package>
        <sys_policy/>
        <sys_scope display_value="PeerCentral">b7f1c56ac397621075ea722ed40131d0</sys_scope>
        <sys_update_name>sp_widget_09377deec39b621075ea722ed4013146</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-10-02 16:58:35</sys_updated_on>
        <template><![CDATA[<main>
  <div class="panel panel-primary">
    <!-- Default panel contents -->
    <section class="panel-heading">
      <h3 class="panel-title">
        <strong>Recognition activity feed</strong>
      </h3>
    </section>

    <nav>
      <ul class="nav nav-tabs">
        <li role="presentation" ng-class="{active: c.activeTab=='you'}">
          <a href="" ng-click="c.setTab('you')">You</a>
        </li>

        <li role="presentation" ng-class="{active: c.activeTab=='team'}">
          <a href="" ng-click="c.setTab('team')">Team</a>
        </li>

        <li role="presentation" ng-class="{active: c.activeTab=='all'}">
          <a href="" ng-click="c.setTab('all')">All</a>
        </li>

        <li class="pull-right">
          <a href="" ng-click="!c.isLoading && c.setTab(c.activeTab)" title="Refresh feed"
            class="btn btn-default btn-sm refresh-btn" ng-class="{'is-loading': c.isLoading}">
            <i class="fa fa-refresh" ng-class="{'fa-spin': c.isLoading}" aria-hidden="true"></i>
            <span class="sr-only">Refresh</span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="controls-bar">
      <div class="filters">
        <span>Filter by: </span>

        <div class="filter-wrapper" ng-show="c.activeTab=='you'">
          <sp-widget widget="c.data.activityFilterWidget"></sp-widget>
        </div>

        <div class="filter-wrapper" ng-show="c.activeTab!='you'">
          <sp-widget widget="c.data.teamMemberFilterWidget"></sp-widget>
        </div>
        <div class="filter-wrapper" ng-show="c.activeTab!='you'">
          <sp-widget widget="c.data.teamFilterWidget"></sp-widget>
        </div>

        <div class="filter-wrapper">
          <sp-widget widget="c.data.timeframeFilterWidget"></sp-widget>
        </div>

        <div class="filter-wrapper">
          <sp-widget widget="c.data.occasionFilterWidget"></sp-widget>
        </div>

        <a href ng-click="c.resetFilters()" ng-show="c.hasActiveFilters()" class="reset-link"
          title="Reset filters">↺</a>
      </div>

      <div class="filter-wrapper">
        <sp-widget widget="c.data.sortOrderWidget"></sp-widget>
      </div>
    </div>



    <div class="alert refresh-indicator is-sticky" ng-if="c.showRefreshIndicator" aria-live="polite">
      <div class="refresh-indicator-content">
        <i class="fa fa-bell-o refresh-icon" aria-hidden="true"></i>
        New recognition available!
      </div>
      <div class="refresh-indicator-actions">
        <button class="btn btn-xs btn-primary" ng-click="c.refreshAndShow()">Refresh</button>
        <button type="button" class="close" ng-click="c.showRefreshIndicator = false"
          aria-label="Dismiss">&times;</button>
      </div>
    </div>

    <!-- List group -->
    <section class="feed-container">
      <div ng-if="c.isLoading" class="feed-loading-overlay">
        <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
      </div>



      <div ng-if="c.isLoading" class="feed-loading-overlay">
        <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
      </div>

      <ul class="list-group feed-content" ng-class="{'content-faded': c.isLoading}">
        <li ng-repeat="recognition in c.data.filteredRecognitions track by recognition.id" class="list-group-item">
          <article class="media">
            <div class="media-left">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x text-info"></i>
                <span class="fa-stack-1x fa-inverse">{{recognition.senderInitials}}</span>
              </span>
            </div>

            <div class="media-body p-5">
              <h4 class="media-heading">
                <a href>{{recognition.senderDisplay}}</a> gave
                applause to
                <a href>{{recognition.recipients.join(', ')}}</a>

                <small class="text-muted pull-right">
                  <span ng-if="recognition.isNew" class="label label-default new-badge">New</span>
                  {{recognition.timeAgo}}
                </small>
              </h4>

              <span class="recognition-indicators mb-5 pull-right">
                <abbr title="Private Recognition" class="private-indicator initialism ml-10"
                  ng-if="recognition.isPrivate">
                  <i class="fa fa-lock" aria-hidden="true"></i>
                </abbr>

                <abbr title="Team Recognition" class="team-indicator initialism ml-10" ng-if="recognition.isTeam">
                  <i class="fa fa-users" aria-hidden="true"></i>
                </abbr>
              </span>

              <p ng-if="recognition.message" ng-bind-html="recognition.message"></p>

              <span ng-repeat="occasion in recognition.occasions">
                <small class="label label-default occasion-tag" title="{{occasion}}">
                  <strong>{{occasion}}</strong> </small>&nbsp;
              </span>
            </div>
          </article>
        </li>

        <li class="text-center" ng-if="c.data.filteredRecognitions.length > 0">
          <div class="well well-sm text-center mb-0">
            <p class="text-muted small">
              Showing
              <strong>{{c.data.filteredRecognitions.length}}</strong>
              {{c.data.filteredRecognitions.length === 1 ?
              'recognition' : 'recognitions'}}
            </p>

            <div ng-if="c.canLoadMore">
              <button class="btn btn-primary btn-sm" ng-click="c.loadMore()" ng-disabled="c.isLoadingMore">
                <i class="fa" ng-class="{'fa-spin fa-spinner': c.isLoadingMore, 'fa-arrow-down': !c.isLoadingMore}"></i>
                {{c.isLoadingMore ? 'Loading...' : 'Load More'}}
              </button>
            </div>

            <p ng-if="!c.canLoadMore && c.data.filteredRecognitions.length > 0"
              class="text-center text-muted small m-0">
              <em>— You've reached the end of the list —</em>
            </p>
          </div>
        </li>

        <li ng-if="!c.data.filteredRecognitions.length" class="list-group-item text-center pt-20 pb-20">
          <div class="p-20">
            <p class="text-muted">
              <i class="fa fa-trophy fa-3x" aria-hidden="true"></i>
            </p>
            <h4 class="text-muted">No Recognitions Found</h4>
            <p class="small text-muted">
              Try adjusting your filters or check back later.
            </p>
          </div>
        </li>
      </ul>
    </section>
  </div>
</main>]]></template>
    </sp_widget>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>09377deec39b621075ea722ed4013146</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-08-14 13:19:41</sys_created_on>
        <sys_id>8d377deec39b621075ea722ed4013148</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-08-14 13:19:41</sys_updated_on>
        <table>sp_widget</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
