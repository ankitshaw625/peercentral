<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function ($scope, $rootScope, $document, $element) {
  var c = this;

  // This holds the final, confirmed selections
  c.selectedOptions = [];
  c.dropdownVisible = false;

  // This object holds the temporary state of the modal while it's open
  c.modal = {
    available: [],
    searchTerm: '',
    searchTermSelected: '',
    selected: [],
    selections: {
      available: [],
      selected: []
    }
  };


  c.performSearch = function (searchTerm) {
    if (c.data.type !== 'dynamic' || !searchTerm || searchTerm.length < 2) {
      c.modal.searching = false;
      return;
    }

    c.modal.searching = true;

    c.server.get({
      action: 'search_choices',
      searchTerm: searchTerm,
      dataConfig: c.options.dataConfig
    }).then(function (response) {

      const newChoices = response.data.searchResults;

      if (newChoices && newChoices.length > 0) {
        var existingValues = new Set(c.data.availableOptions.map(function (item) {
          return item.value;
        }));

        newChoices.forEach(function (item) {
          if (!existingValues.has(item.value)) {
            c.data.availableOptions.push(item);
          }
        });

        populateModalLists();
      }

      c.modal.searching = false;
    });
  };

  c.toggleDropdown = function () {
    // If opening, populate the lists first
    if (!c.dropdownVisible)
      populateModalLists();

    c.dropdownVisible = !c.dropdownVisible;
  };

  function populateModalLists() {
    var selectedValues = c.selectedOptions.map(function (item) { return item.value; });

    c.modal.selected = angular.copy(c.selectedOptions);

    c.modal.available = c.data.availableOptions.filter(function (item) {
      return !selectedValues.includes(item.value);
    });
  }

  c.closeDropdown = function () {
    c.dropdownVisible = false;
  };

  c.applySelection = function () {
    // Update the widget's display with the new selections
    c.selectedOptions = c.modal.selected;

    // Broadcast an event with the event name from widget options
    // Any other widget on the page can listen for this event
    $rootScope.$broadcast(c.data.eventName, {
      selected: c.selectedOptions
    });

    // Close the dropdown
    c.closeDropdown();
  };

  c.clearModalSelection = function ($event) {
    $event && $event.stopPropagation();
    // This function can simply reuse your existing removeAll logic,
    // which moves all selected items back to the available list.
    c.removeAll();
  };

  $scope.$on('filters.reset', function () {
    // When the reset event is heard, clear all selected options.
    c.selectedOptions = [];
  });

  // --- Slushbucket Logic ---
  // These functions operate on the temporary 'c.modal' object
  c.addSelected = function () {
    c.modal.selected = c.modal.selected.concat(c.modal.selections.available);
    c.modal.available = c.modal.available.filter(function (item) {
      return c.modal.selections.available.indexOf(item) < 0;
    });
    c.modal.selections.available = [];
  };

  c.addAll = function () {
    c.modal.selected = c.modal.selected.concat(c.modal.available);
    c.modal.available = [];
  };

  c.removeSelected = function () {
    c.modal.available = c.modal.available.concat(c.modal.selections.selected);
    c.modal.selected = c.modal.selected.filter(function (item) {
      return c.modal.selections.selected.indexOf(item) < 0;
    });
    c.modal.selections.selected = [];
  };

  c.removeAll = function () {
    c.modal.available = c.modal.available.concat(c.modal.selected);
    c.modal.selected = [];
  };

  // ADD THIS HANDLER
  var handleClickOutside = function (event) {
    var isDescendant = $element[0].contains(event.target);
    if (!isDescendant && c.dropdownVisible) {
      $scope.$apply(function () {
        c.closeDropdown();
      });
    }
  };

  $document.on('click', handleClickOutside);
  $scope.$on('$destroy', function () {
    $document.off('click', handleClickOutside);
  });
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.filter-display {
    display: inline-flex;
    max-width: 100%;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 6px 12px;
    background-color: #fff;
    cursor: pointer;
    min-height: 38px;
    transition: border-color 0.2s ease-in-out;

    &amp;:hover {
        border-color: #999;
    }
}

.filter-content {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.filter-label {
    font-weight: 500;
    margin-right: 6px;
}

.filter-selection-text {
    font-weight: 600;
}

.filter-caret {
    margin-left: 10px;
    color: #888;
}

.slush-filter-widget {
    position: relative;
}

.slush-select-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
}

.slush-select-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
}

.slush-select {
    height: 192px; /* Adjust height as needed */
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 5px;
    background-color: #f9f9f9;
}

.slush-select option {
    padding: 4px 5px;
    cursor: pointer;
    border-radius: 3px;
    margin-bottom: 2px;
}

.slush-select option:hover {
    background-color: #eef5ff;
}

.slush-select:focus {
    outline: none;
    border-color: #66afe9;
    box-shadow: 0 0 4px rgba(102, 175, 233, 0.6);
}

.left-slushbucket {
    padding-right: 0;
}

.right-slushbucket {
    padding-left: 0;
}

.slushbucket-button-col {
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.slush-buttons .btn {
    margin-bottom: 10px;
}

.slushbucket-row {
    display: flex;
    gap: 15px;
}

.slushbucket-dropdown-panel {
    position: absolute;
    top: 100%;
    left: 0;
    transform: none;
    z-index: 1000;
    margin-top: 4px;
    width: 512px;
    max-width: 90vw;
    padding: 10px;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
}

.slushbucket-footer {
    text-align: right;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #eee;
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>multi-select-slushbucket-filter</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Multi Select Dropdown Filter</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function () {

  if (input && input.action === 'search_choices') {
    data.searchResults = getChoices(input.searchTerm, input.dataConfig);
    return;
  }

  // Get common configuration from widget options
  data.title = options.title || 'Filter';
  data.eventName = options.eventName || 'slushbucket.filter.updated';
  data.availableOptions = [];

  data.type = options.type || 'static';

  if (data.type == 'static') {
    data.availableOptions = options.choices || [];
    return;
  } else {
    data.availableOptions = getChoices(null);
  }



  function getChoices(searchTerm, dataConfig) {
    const choices = [];
    dataConfig = dataConfig || options.dataConfig;

    const tableName = dataConfig.tableName;
    const displayField = dataConfig.displayField;
    const valueField = dataConfig.valueField;
    const limit = parseInt(dataConfig.limit, 10) || 50;
    const encodedQuery = dataConfig.encodedQuery || '';

    // Ensure mandatory options are present for a dynamic query
    if (!tableName || !displayField || !valueField) {
      gs.error(
        'Multi Select Filter widget: Missing mandatory options for dynamic type (tableName, displayField, valueField)'
      );
      return choices;
    }

    const gr = new GlideRecord(tableName);

    if (encodedQuery) {
      gr.addEncodedQuery(encodedQuery);
    }

    // Conditionally add the search term to the query
    if (searchTerm) {
      gr.addQuery(displayField, 'CONTAINS', searchTerm);
    }

    gr.setLimit(limit);
    gr.orderBy(displayField);
    gr.query();

    while (gr.next()) {
      choices.push({
        display: gr.getDisplayValue(displayField),
        value: gr.getValue(valueField),
      });
    }

    return choices;
  }
})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-09-20 18:10:13</sys_created_on>
        <sys_id>bd8c55a2c38c361075ea722ed40131dc</sys_id>
        <sys_mod_count>120</sys_mod_count>
        <sys_name>Multi Select Dropdown Filter</sys_name>
        <sys_package display_value="PeerCentral" source="x_1794402_peerce_0">b7f1c56ac397621075ea722ed40131d0</sys_package>
        <sys_policy/>
        <sys_scope display_value="PeerCentral">b7f1c56ac397621075ea722ed40131d0</sys_scope>
        <sys_update_name>sp_widget_bd8c55a2c38c361075ea722ed40131dc</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-11-23 13:31:05</sys_updated_on>
        <template><![CDATA[<div class="slush-filter-widget">
  <div class="filter-display" ng-click="c.toggleDropdown()" title="Click to edit filter">

    <div class="filter-content">
      <span class="filter-label">{{c.data.title}}:</span>

      <span class="filter-selection-text">
        <span ng-if="!c.selectedOptions.length" class="text-muted">Select...</span>
        <span ng-if="c.selectedOptions.length === 1">{{c.selectedOptions[0].display}}</span>
        <span ng-if="c.selectedOptions.length > 1">({{c.selectedOptions.length}} Selected)</span>
      </span>
    </div>

    <i class="fa fa-caret-down filter-caret"></i>
  </div>

  <div ng-if="c.dropdownVisible" class="slushbucket-dropdown-panel panel panel-default">
    <div class="panel-heading mb-10">
      <h4 class="panel-title">
        Select {{c.data.title}}
        <button ng-click="c.closeDropdown()" type="button" class="close" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </h4>
    </div>

    <div class="row slushbucket-row">

      <div class="col-xs-5 left-slushbucket">
        <label>Available</label>
        <div class="form-group">
          <input type="text" class="form-control" ng-model="c.modal.searchTerm"
            ng-change="c.performSearch(c.modal.searchTerm)" ng-model-options="{ debounce: 500 }"
            placeholder="{{c.data.type === 'dynamic' ? 'Search all (2+ chars)...' : 'Search available...'}}" />
        </div>

        <!-- Wrap select in a relative container for overlay -->
        <div class="slush-select-wrapper">
          <select multiple class="form-control slush-select" ng-model="c.modal.selections.available"
            ng-options="item as item.display for item in c.modal.available | filter:c.modal.searchTerm | orderBy: 'display'"
            ng-dblclick="c.addSelected()"></select>

          <!-- Spinner overlay -->
          <div ng-if="c.modal.searching" class="slush-select-overlay">
            <i class="fa fa-spinner fa-spin fa-2x"></i>
          </div>
        </div>
      </div>




      <div class="col-xs-1 text-center slushbucket-button-col">
        <div class="slush-buttons">
          <button class="btn btn-default btn-block" ng-click="c.addAll()" title="Add all">
            <i class="fa fa-angle-double-right"></i>
          </button>
          <button class="btn btn-primary btn-block" ng-click="c.addSelected()" title="Add selected">
            <i class="fa fa-angle-right"></i>
          </button>
          <button class="btn btn-primary btn-block" ng-click="c.removeSelected()" title="Remove selected">
            <i class="fa fa-angle-left"></i>
          </button>
          <button class="btn btn-default btn-block" ng-click="c.removeAll()" title="Remove all">
            <i class="fa fa-angle-double-left"></i>
          </button>
        </div>
      </div>

      <div class="col-xs-5 right-slushbucket">
        <label>Selected</label>
        <div class="form-group">
          <input type="text" class="form-control" ng-model="c.modal.searchTermSelected"
            placeholder="Search selected..." />
        </div>
        <select multiple class="form-control slush-select" ng-model="c.modal.selections.selected"
          ng-options="item as item.display for item in c.modal.selected | filter:c.modal.searchTermSelected | orderBy: 'display'"
          ng-dblclick="c.removeSelected()"></select>
      </div>
    </div>

    <div class="slushbucket-footer clearfix">
      <button class="btn btn-default btn-sm pull-left" ng-if="c.modal.selected.length > 0"
        ng-click="c.clearModalSelection($event)">
        Clear
      </button>


      <button class="btn btn-primary btn-sm" ng-click="c.applySelection()">
        Apply
      </button>
    </div>

  </div>

</div>


<!--
  <div ng-if="c.modal.visible" class="modal-backdrop fade in"></div>
  <div ng-if="c.modal.visible" class="modal fade in" style="display: block;">
    <div class="modal-dialog"> <div class="modal-content">
        <div class="modal-header">
          <button ng-click="c.closeModal()" type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Select {{c.data.title}}</h4>
        </div>
        <div class="modal-body">
          <div class="row slushbucket-row">
            <div class="col-xs-5 left-slushbucket">
              <label>Available</label>
              <div class="form-group">
                <input type="text" 
                       class="form-control" 
                       ng-model="c.modal.searchTerm" 
                       placeholder="Search available...">
              </div>
              <select multiple class="form-control slush-select" ng-model="c.modal.selections.available" ng-options="item as item.display for item in c.modal.available | filter:c.modal.searchTerm | orderBy: 'display'" ng-dblclick="c.addSelected()"></select>
            </div>
            
          <div class="col-xs-1 text-center slushbucket-button-col">
            <div class="slush-buttons">
              <button class="btn btn-default btn-block" ng-click="c.addAll()" title="Add all"><i class="fa fa-angle-double-right"></i></button>
              <button class="btn btn-primary btn-block" ng-click="c.addSelected()" title="Add selected"><i class="fa fa-angle-right"></i></button>
              <button class="btn btn-primary btn-block" ng-click="c.removeSelected()" title="Remove selected"><i class="fa fa-angle-left"></i></button>
              <button class="btn btn-default btn-block" ng-click="c.removeAll()" title="Remove all"><i class="fa fa-angle-double-left"></i></button>
            </div>
          </div>
            
            <div class="col-xs-5 right-slushbucket">
              <label>Selected</label>
                <div class="form-group">
                  <input type="text" 
                         class="form-control" 
                         ng-model="c.modal.searchTermSelected" 
                         placeholder="Search selected...">
                </div>
              <select multiple class="form-control slush-select" ng-model="c.modal.selections.selected" ng-options="item as item.display for item in c.modal.selected | filter:c.modal.searchTermSelected | orderBy: 'display'" ng-dblclick="c.removeSelected()"></select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" ng-click="c.closeModal()">Cancel</button>
          <button class="btn btn-primary" ng-click="c.applySelection()">Apply</button>
        </div>
      </div>
    </div>
  </div>
  -->


</div>]]></template>
    </sp_widget>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>bd8c55a2c38c361075ea722ed40131dc</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-09-20 18:10:13</sys_created_on>
        <sys_id>bd8c5d2ac340761075ea722ed4013108</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-09-20 18:10:13</sys_updated_on>
        <table>sp_widget</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
